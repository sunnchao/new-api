# 套餐管理系统架构图

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端层 (React)                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────────┐      ┌──────────────────────┐        │
│  │  用户套餐管理页面      │      │  管理员套餐管理页面    │        │
│  │  /console/           │      │  /console/           │        │
│  │  subscriptions       │      │  admin-packages      │        │
│  └──────────────────────┘      └──────────────────────┘        │
│           │                              │                       │
│           │                              │                       │
│           ▼                              ▼                       │
│  ┌─────────────────────────────────────────────────┐           │
│  │           API Helper (axios)                     │           │
│  └─────────────────────────────────────────────────┘           │
│                                                                   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ HTTP/HTTPS
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                      后端层 (Gin/Go)                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────────┐      ┌──────────────────────┐        │
│  │   用户路由组          │      │   管理员路由组         │        │
│  │   /api/user/         │      │   /api/packages-     │        │
│  │   packages           │      │   admin              │        │
│  └──────────────────────┘      └──────────────────────┘        │
│           │                              │                       │
│           │                              │                       │
│           ▼                              ▼                       │
│  ┌─────────────────────────────────────────────────┐           │
│  │         Packages Controller                      │           │
│  │  - GetPackagesPlans                             │           │
│  │  - GetPackagesSubscription                      │           │
│  │  - PurchasePackagesSubscription                 │           │
│  │  - CancelPackagesSubscription                   │           │
│  │  - GetAllPackagesSubscriptions                  │           │
│  │  - AdminGrantPackagesSubscription               │           │
│  │  - AdminCancelPackagesSubscription              │           │
│  │  - CreatePackagesPlan                           │           │
│  │  - UpdatePackagesPlan                           │           │
│  │  - DeletePackagesPlan                           │           │
│  └─────────────────────────────────────────────────┘           │
│           │                                                       │
│           │                                                       │
│           ▼                                                       │
│  ┌─────────────────────────────────────────────────┐           │
│  │         Model Layer                              │           │
│  │  - PackagesPlan                                 │           │
│  │  - PackagesSubscription                         │           │
│  └─────────────────────────────────────────────────┘           │
│                                                                   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ SQL
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                      数据库层                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────────┐      ┌──────────────────────┐        │
│  │  packages_plans      │      │  packages_           │        │
│  │  表                  │      │  subscriptions       │        │
│  │                      │      │  表                  │        │
│  │  - id               │      │  - id                │        │
│  │  - name             │      │  - user_id           │        │
│  │  - type             │      │  - plan_type         │        │
│  │  - price            │      │  - status            │        │
│  │  - total_quota      │      │  - total_quota       │        │
│  │  - service_type     │      │  - remain_quota      │        │
│  │  - ...              │      │  - start_time        │        │
│  │                      │      │  - end_time          │        │
│  └──────────────────────┘      │  - ...               │        │
│                                 └──────────────────────┘        │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 用户套餐管理流程

```
┌─────────┐
│  用户    │
└────┬────┘
     │
     │ 1. 访问 /console/subscriptions
     ▼
┌─────────────────────┐
│  Subscriptions      │
│  Component          │
└─────────────────────┘
     │
     │ 2. 加载数据
     ▼
┌─────────────────────┐
│  API.get()          │
│  - /plans           │
│  - /subscriptions   │
└─────────────────────┘
     │
     │ 3. 返回数据
     ▼
┌─────────────────────┐
│  显示套餐列表        │
│  显示订阅列表        │
└─────────────────────┘
     │
     │ 4. 用户点击购买
     ▼
┌─────────────────────┐
│  打开购买弹窗        │
│  选择套餐           │
└─────────────────────┘
     │
     │ 5. 确认购买
     ▼
┌─────────────────────┐
│  API.post()         │
│  /purchase          │
└─────────────────────┘
     │
     │ 6. 购买成功
     ▼
┌─────────────────────┐
│  刷新订阅列表        │
│  显示成功提示        │
└─────────────────────┘
```

## 管理员套餐管理流程

```
┌─────────┐
│ 管理员   │
└────┬────┘
     │
     │ 1. 访问 /console/admin-packages
     ▼
┌─────────────────────┐
│  AdminPackages      │
│  Component          │
└─────────────────────┘
     │
     │ 2. 加载订阅列表
     ▼
┌─────────────────────┐
│  API.get()          │
│  /subscriptions     │
│  (分页)             │
└─────────────────────┘
     │
     │ 3. 显示订阅表格
     ▼
┌─────────────────────┐
│  订阅列表表格        │
│  - 用户信息         │
│  - 套餐信息         │
│  - 状态             │
│  - 操作按钮         │
└─────────────────────┘
     │
     │ 4. 点击分发套餐
     ▼
┌─────────────────────┐
│  打开分发弹窗        │
└─────────────────────┘
     │
     │ 5. 搜索用户
     ▼
┌─────────────────────┐
│  API.get()          │
│  /users/search      │
└─────────────────────┘
     │
     │ 6. 选择用户和套餐
     ▼
┌─────────────────────┐
│  API.post()         │
│  /grant-            │
│  subscription       │
└─────────────────────┘
     │
     │ 7. 分发成功
     ▼
┌─────────────────────┐
│  刷新订阅列表        │
│  显示成功提示        │
└─────────────────────┘
```

## API端点映射

### 用户端点

| 前端调用 | 后端路由 | 控制器方法 | 说明 |
|---------|---------|-----------|------|
| `GET /api/user/packages/plans` | `/api/user/packages/plans` | `GetPackagesPlans` | 获取套餐列表 |
| `GET /api/user/packages/subscriptions` | `/api/user/packages/subscriptions` | `GetPackagesSubscription` | 获取用户订阅 |
| `POST /api/user/packages/purchase` | `/api/user/packages/purchase` | `PurchasePackagesSubscription` | 购买套餐 |
| `POST /api/user/packages/cancel` | `/api/user/packages/cancel` | `CancelPackagesSubscription` | 取消订阅 |

### 管理员端点

| 前端调用 | 后端路由 | 控制器方法 | 说明 |
|---------|---------|-----------|------|
| `GET /api/packages-admin/subscriptions` | `/api/packages-admin/subscriptions` | `GetAllPackagesSubscriptions` | 获取所有订阅 |
| `GET /api/packages-admin/plans` | `/api/packages-admin/plans` | `GetPackagesPlans` | 获取套餐计划 |
| `GET /api/packages-admin/users/search` | `/api/packages-admin/users/search` | `AdminSearchUsers` | 搜索用户 |
| `POST /api/packages-admin/grant-subscription` | `/api/packages-admin/grant-subscription` | `AdminGrantPackagesSubscription` | 分发套餐 |
| `DELETE /api/packages-admin/subscriptions/:id` | `/api/packages-admin/subscriptions/:id` | `AdminCancelPackagesSubscription` | 取消/删除订阅 |

## 权限控制

```
┌─────────────────────────────────────────────────────────────┐
│                      路由权限控制                             │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  用户套餐页面                                                  │
│  ┌─────────────────────────────────────────────┐            │
│  │  Route: /console/subscriptions              │            │
│  │  Component: <PrivateRoute>                  │            │
│  │  Required: 登录用户                          │            │
│  └─────────────────────────────────────────────┘            │
│                                                               │
│  管理员套餐页面                                                │
│  ┌─────────────────────────────────────────────┐            │
│  │  Route: /console/admin-packages             │            │
│  │  Component: <AdminRoute>                    │            │
│  │  Required: 管理员权限                        │            │
│  └─────────────────────────────────────────────┘            │
│                                                               │
│  API权限控制                                                  │
│  ┌─────────────────────────────────────────────┐            │
│  │  /api/user/packages/*                       │            │
│  │  Middleware: UserAuth()                     │            │
│  └─────────────────────────────────────────────┘            │
│                                                               │
│  ┌─────────────────────────────────────────────┐            │
│  │  /api/packages-admin/*                      │            │
│  │  Middleware: AdminAuth()                    │            │
│  └─────────────────────────────────────────────┘            │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## 数据流向

```
用户操作 → 前端组件 → API请求 → 后端路由 → 中间件验证 → 控制器 → 模型层 → 数据库
                                                                    ↓
用户界面 ← 前端组件 ← API响应 ← 后端路由 ← JSON响应 ← 控制器 ← 模型层 ← 数据库
```

## 状态管理

```
┌─────────────────────────────────────────────────────────────┐
│                    组件状态管理                               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  Subscriptions Component                                     │
│  ┌─────────────────────────────────────────────┐            │
│  │  State:                                     │            │
│  │  - plans: []           // 套餐列表          │            │
│  │  - subscriptions: []   // 订阅列表          │            │
│  │  - loading: false      // 加载状态          │            │
│  │  - purchaseOpen: false // 购买弹窗          │            │
│  │  - selectedPlan: null  // 选中套餐          │            │
│  │  - error: ''           // 错误信息          │            │
│  └─────────────────────────────────────────────┘            │
│                                                               │
│  AdminPackages Component                                     │
│  ┌─────────────────────────────────────────────┐            │
│  │  State:                                     │            │
│  │  - activeTab: 'subscriptions' // 当前标签   │            │
│  │  - subscriptions: []   // 订阅列表          │            │
│  │  - plans: []           // 套餐列表          │            │
│  │  - users: []           // 用户搜索结果      │            │
│  │  - loading: false      // 加载状态          │            │
│  │  - activePage: 1       // 当前页码          │            │
│  │  - pageSize: 10        // 每页数量          │            │
│  │  - total: 0            // 总数              │            │
│  │  - selectedUser: null  // 选中用户          │            │
│  │  - selectedPlan: null  // 选中套餐          │            │
│  │  - grantModalOpen: false // 分发弹窗       │            │
│  │  - error: ''           // 错误信息          │            │
│  └─────────────────────────────────────────────┘            │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## 技术栈总览

```
┌─────────────────────────────────────────────────────────────┐
│                        技术栈                                 │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  前端                                                         │
│  ├─ React 18                                                 │
│  ├─ React Router v6                                          │
│  ├─ @douyinfe/semi-ui                                        │
│  ├─ react-i18next                                            │
│  ├─ axios                                                    │
│  └─ Tailwind CSS                                             │
│                                                               │
│  后端                                                         │
│  ├─ Go 1.21+                                                 │
│  ├─ Gin Web Framework                                        │
│  ├─ GORM (ORM)                                               │
│  └─ JWT (认证)                                               │
│                                                               │
│  数据库                                                       │
│  ├─ SQLite (默认)                                            │
│  ├─ MySQL 5.7.8+                                             │
│  └─ PostgreSQL 9.6+                                          │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```
